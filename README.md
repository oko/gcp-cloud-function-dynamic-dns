# GCP Cloud Functions Dynamic DNS
This repository contains an implementation of dynamic DNS updating based on Google Cloud Platform's DNS service.

## Requirements
For production use:

* GCP account with:
  * DNS and Datastore APIs activated
  * A DNS zone for dynamic updates to be written to
  * A datastore created
  * A Cloud Function with Python 3.7 runtime selected

For local testing and client registration:

* Service account credentials file in `GOOGLE_APPLICATION_CREDENTIALS` environment variable with DNS (read/write) and Datastore (read) roles active

## Design
### Client Authentication and Association
Clients should send their auth token as header `X-Token`.

Client configurations and auth tokens are stored in GCP Datastore with kind `dynamic_dns_auth_key`.

Key identifiers can be autogenerated uniques, as lookups are done against properties. The properties used by this function are:

* `token`: the client auth token to match against
* `name`: the record set name of the client
* `zone`: the GCP DNS zone name (*not* the DNS name, i.e. this should be `example-com` not `example.com.`)

### Dynamic DNS
When a client connects, its source IP is extracted from the server request information (either `request.remote_addr` or the `X-Forwarded-For` header, if set). This address is then examined for IPv4/IPv6 to select the record type to update.

Existing record sets *for that record type* are then discovered and marked for removal in the change transaction. A new record set with the same record type is created with the current source IP address.

## Client Setup

Example client `laptop.pc` in DNS zone `example.com` with GCP name `example-com` and project `example-project`:

1.  Use `manager.py` to register a client:
    ```
    $ ./manager.py register --project example-project laptop.pc example-com
    91601a839c2f5f84d2ddd1b964cd0900993285c32166a681e85a577d0b1380bf laptop.pc example-com
    ```
    
2.  Configure `cron` or `systemd` timers to trigger the following:

    ```
    $ curl -4 -H 'Token: <token>' <function-url>
    $ curl -6 -H 'Token: <token>' <function-url>
    ```

3. Verify that the DNS name for the client has been updated:

    ```
    $ dig laptop.pc.example.com A
    $ dig laptop.pc.example.com AAAA
    ```
 